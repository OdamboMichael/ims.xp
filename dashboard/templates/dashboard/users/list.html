{% extends 'base.html' %}
{% load static %}

{% block title %}User Management - Xpert Farmer IMS{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-md-3 col-lg-2 d-md-block sidebar">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'dashboard:home' %}">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{% url 'users:list' %}">
                            <i class="fas fa-users me-2"></i>Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'settings:account' %}">
                            <i class="fas fa-cog me-2"></i>Settings
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">User Management</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <a href="{% url 'users:create' %}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus me-1"></i>Add New User
                    </a>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" placeholder="Search users by name, email, or role..." id="userSearch">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="roleFilter">
                                <option value="">All Roles</option>
                                <option value="admin">Admin</option>
                                <option value="manager">Manager</option>
                                <option value="analyst">Data Analyst</option>
                                <option value="viewer">Viewer</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Total Users</h5>
                            <h1 class="display-6">24</h1>
                            <p class="card-text text-success">
                                <i class="fas fa-arrow-up me-1"></i>+3 this month
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Active Users</h5>
                            <h1 class="display-6">18</h1>
                            <p class="card-text">75% of total</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Admins</h5>
                            <h1 class="display-6">4</h1>
                            <p class="card-text">17% of total</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Managers</h5>
                            <h1 class="display-6">8</h1>
                            <p class="card-text">33% of total</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">System Users</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="usersTable">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" class="form-check-input" id="selectAll">
                                    </th>
                                    <th>USER</th>
                                    <th>NAME</th>
                                    <th>EMAIL</th>
                                    <th>ROLE</th>
                                    <th>LAST LOGIN</th>
                                    <th>STATUS</th>
                                    <th>ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input user-checkbox">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm me-2">
                                                <span class="avatar-initial rounded-circle bg-primary">JD</span>
                                            </div>
                                            <div>
                                                <small class="text-muted">ID: USR-001</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td><strong>John Doe</strong></td>
                                    <td>john.doe@example.com</td>
                                    <td>
                                        <span class="badge bg-danger">Admin</span>
                                    </td>
                                    <td>2023-11-15 14:30</td>
                                    <td>
                                        <span class="badge bg-success">Active</span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'users:manage' user_id=1 %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewUserModal" onclick="viewUser(1)">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDelete(1)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input user-checkbox">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm me-2">
                                                <span class="avatar-initial rounded-circle bg-success">JS</span>
                                            </div>
                                            <div>
                                                <small class="text-muted">ID: USR-002</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td><strong>Jane Smith</strong></td>
                                    <td>jane.smith@example.com</td>
                                    <td>
                                        <span class="badge bg-warning">Manager</span>
                                    </td>
                                    <td>2023-11-14 09:15</td>
                                    <td>
                                        <span class="badge bg-success">Active</span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'users:manage' user_id=2 %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewUserModal" onclick="viewUser(2)">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDelete(2)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input user-checkbox">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm me-2">
                                                <span class="avatar-initial rounded-circle bg-info">PJ</span>
                                            </div>
                                            <div>
                                                <small class="text-muted">ID: USR-003</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td><strong>Peter Jones</strong></td>
                                    <td>peter.jones@example.com</td>
                                    <td>
                                        <span class="badge bg-info">Viewer</span>
                                    </td>
                                    <td>2023-11-13 11:45</td>
                                    <td>
                                        <span class="badge bg-success">Active</span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'users:manage' user_id=3 %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewUserModal" onclick="viewUser(3)">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDelete(3)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input user-checkbox">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm me-2">
                                                <span class="avatar-initial rounded-circle bg-warning">MW</span>
                                            </div>
                                            <div>
                                                <small class="text-muted">ID: USR-004</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td><strong>Mary Williams</strong></td>
                                    <td>mary.williams@example.com</td>
                                    <td>
                                        <span class="badge bg-warning">Manager</span>
                                    </td>
                                    <td>2023-11-12 16:20</td>
                                    <td>
                                        <span class="badge bg-secondary">Inactive</span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'users:manage' user_id=4 %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewUserModal" onclick="viewUser(4)">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDelete(4)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input user-checkbox">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm me-2">
                                                <span class="avatar-initial rounded-circle bg-secondary">RB</span>
                                            </div>
                                            <div>
                                                <small class="text-muted">ID: USR-005</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td><strong>Robert Brown</strong></td>
                                    <td>robert.brown@example.com</td>
                                    <td>
                                        <span class="badge bg-success">Analyst</span>
                                    </td>
                                    <td>2023-11-10 08:45</td>
                                    <td>
                                        <span class="badge bg-success">Active</span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'users:manage' user_id=5 %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewUserModal" onclick="viewUser(5)">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmDelete(5)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <select class="form-select form-select-sm d-inline-block w-auto" id="bulkAction">
                                <option value="">Bulk Actions</option>
                                <option value="activate">Activate Selected</option>
                                <option value="deactivate">Deactivate Selected</option>
                                <option value="delete">Delete Selected</option>
                                <option value="export">Export Selected</option>
                            </select>
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="applyBulkAction()">Apply</button>
                        </div>
                        <div>
                            <span class="text-muted">Showing 1 to 5 of 24 results</span>
                            <div class="btn-group ms-3">
                                <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-chevron-left"></i></button>
                                <button class="btn btn-sm btn-outline-secondary active">1</button>
                                <button class="btn btn-sm btn-outline-secondary">2</button>
                                <button class="btn btn-sm btn-outline-secondary">3</button>
                                <button class="btn btn-sm btn-outline-secondary">4</button>
                                <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Role Distribution Chart -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Role Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <canvas id="roleDistributionChart" height="200"></canvas>
                        </div>
                        <div class="col-md-4">
                            <div class="list-group">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Admin
                                    <span class="badge bg-danger rounded-pill">4</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Manager
                                    <span class="badge bg-warning rounded-pill">8</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Data Analyst
                                    <span class="badge bg-success rounded-pill">6</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Viewer
                                    <span class="badge bg-info rounded-pill">6</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- View User Modal -->
<div class="modal fade" id="viewUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetails">
                <!-- User details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Edit User</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this user? This action cannot be undone.</p>
                <p class="text-muted">All data associated with this user will be permanently removed.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteUser()">Delete User</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let selectedUserId = null;

    document.addEventListener('DOMContentLoaded', function() {
        initializeUserCharts();
        
        // Select all checkbox
        document.getElementById('selectAll').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
        
        // Search functionality
        document.getElementById('userSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#usersTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
        
        // Filter functionality
        document.getElementById('roleFilter').addEventListener('change', filterUsers);
        document.getElementById('statusFilter').addEventListener('change', filterUsers);
    });

    function filterUsers() {
        const roleFilter = document.getElementById('roleFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const rows = document.querySelectorAll('#usersTable tbody tr');
        
        rows.forEach(row => {
            const role = row.querySelector('td:nth-child(5)').textContent.trim().toLowerCase();
            const status = row.querySelector('td:nth-child(7)').textContent.trim().toLowerCase();
            
            const roleMatch = !roleFilter || role.includes(roleFilter);
            const statusMatch = !statusFilter || status.includes(statusFilter);
            
            row.style.display = roleMatch && statusMatch ? '' : 'none';
        });
    }

    function viewUser(userId) {
        // Simulate loading user data
        const userData = {
            1: {
                name: "John Doe",
                email: "john.doe@example.com",
                role: "Admin",
                status: "Active",
                lastLogin: "2023-11-15 14:30",
                joinDate: "2023-01-15",
                permissions: "Full system access"
            },
            2: {
                name: "Jane Smith",
                email: "jane.smith@example.com",
                role: "Manager",
                status: "Active",
                lastLogin: "2023-11-14 09:15",
                joinDate: "2023-02-20",
                permissions: "Farm management, Reports"
            }
        };
        
        const user = userData[userId] || userData[1];
        const modalContent = `
            <div class="text-center mb-3">
                <div class="avatar avatar-xl mb-2">
                    <span class="avatar-initial rounded-circle bg-primary">${user.name.split(' ').map(n => n[0]).join('')}</span>
                </div>
                <h4>${user.name}</h4>
                <p class="text-muted">${user.email}</p>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Role:</strong> <span class="badge bg-${user.role === 'Admin' ? 'danger' : 'warning'}">${user.role}</span></p>
                    <p><strong>Status:</strong> <span class="badge bg-${user.status === 'Active' ? 'success' : 'secondary'}">${user.status}</span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Last Login:</strong> ${user.lastLogin}</p>
                    <p><strong>Join Date:</strong> ${user.joinDate}</p>
                </div>
            </div>
            <div class="mt-3">
                <p><strong>Permissions:</strong> ${user.permissions}</p>
            </div>
        `;
        
        document.getElementById('userDetails').innerHTML = modalContent;
        selectedUserId = userId;
    }

    function confirmDelete(userId) {
        selectedUserId = userId;
        $('#deleteModal').modal('show');
    }

    function deleteUser() {
        if (selectedUserId) {
            alert(`User ${selectedUserId} deleted successfully`);
            $('#deleteModal').modal('hide');
            // Refresh the page or update the table
            location.reload();
        }
    }

    function applyBulkAction() {
        const action = document.getElementById('bulkAction').value;
        if (!action) {
            alert('Please select a bulk action');
            return;
        }
        
        const selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked'))
            .map(cb => cb.closest('tr').querySelector('td:nth-child(2) small').textContent.split(': ')[1]);
        
        if (selectedUsers.length === 0) {
            alert('Please select at least one user');
            return;
        }
        
        alert(`Applying ${action} to ${selectedUsers.length} user(s)`);
        // Implement bulk action logic here
    }

    function initializeUserCharts() {
        const ctx = document.getElementById('roleDistributionChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Admin', 'Manager', 'Data Analyst', 'Viewer'],
                datasets: [{
                    data: [4, 8, 6, 6],
                    backgroundColor: [
                        '#dc3545',
                        '#ffc107',
                        '#198754',
                        '#0dcaf0'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
</script>
{% endblock %}