{% extends 'base.html' %}
{% load static %}

{% block title %}Account Settings - Xpert Farmer IMS{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Navigation 
        <div class="col-md-3 col-lg-2 d-md-block sidebar">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'dashboard:home' %}">
                            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'users:list' %}">
                            <i class="fas fa-users me-2"></i>Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{% url 'settings:account' %}">
                            <i class="fas fa-cog me-2"></i>Settings
                        </a>
                    </li>
                </ul>-->
                
                <!-- Settings Submenu -->
                <div class="mt-4">
                    <h6 class="sidebar-heading px-3 mb-2">Settings</h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="{% url 'dashboard:settings_account' %}">
                                <i class="fas fa-user-cog me-2"></i>Account
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'dashboard:settings_profile' %}">
                                <i class="fas fa-user me-2"></i>Profile
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'dashboard:settings_institution' %}">
                                <i class="fas fa-building me-2"></i>Institution
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'dashboard:settings_general' %}">
                                <i class="fas fa-sliders-h me-2"></i>General
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Account Settings</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.print()">
                            <i class="fas fa-print me-1"></i>Print
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-question-circle me-1"></i>Help
                        </button>
                    </div>
                </div>
            </div>

            <!-- Account Security Alert -->
            <div class="alert alert-info mb-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-shield-alt fa-2x me-3"></i>
                    <div>
                        <h5 class="alert-heading mb-1">Account Security</h5>
                        <p class="mb-0">Your account was last accessed from <strong>New York, USA</strong> on <strong>Today, 14:30</strong>. If this wasn't you, please change your password immediately.</p>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <!-- Account Information Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Account Information</h5>
                        </div>
                        <div class="card-body">
                            <form id="accountInfoForm">
                                <div class="mb-3">
                                    <label class="form-label">Email Address *</label>
                                    <div class="input-group">
                                        <input type="email" class="form-control" value="admin@farmsystem.io" required>
                                        <span class="input-group-text">
                                            <i class="fas fa-envelope"></i>
                                        </span>
                                    </div>
                                    <div class="form-text">This is your login email. Changing it will require verification.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Current Password</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="currentPassword">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('currentPassword')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">New Password</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="newPasswordAccount">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('newPasswordAccount')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" type="button" onclick="generatePassword('newPasswordAccount', 'confirmNewPassword')">
                                            <i class="fas fa-key"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Minimum 8 characters with uppercase, lowercase, and numbers.</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Confirm New Password</label>
                                    <input type="password" class="form-control" id="confirmNewPassword">
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enable2FA">
                                        <label class="form-check-label" for="enable2FA">
                                            Enable Two-Factor Authentication
                                        </label>
                                    </div>
                                    <div class="form-text">Add an extra layer of security to your account.</div>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-secondary" onclick="resetAccountForm()">
                                        Reset
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>Save Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Security Settings Card -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Security Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <h6>Session Management</h6>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="autoLogout" checked>
                                            <label class="form-check-label" for="autoLogout">
                                                Auto-logout after 30 minutes of inactivity
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h6>Login Alerts</h6>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="emailAlerts" checked>
                                            <label class="form-check-label" for="emailAlerts">
                                                Email me about new sign-ins
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <h6>Password Policy</h6>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="passwordExpiry" checked>
                                            <label class="form-check-label" for="passwordExpiry">
                                                Require password change every 90 days
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h6>Device Management</h6>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="trustDevices">
                                            <label class="form-check-label" for="trustDevices">
                                                Remember this device for 30 days
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-outline-primary" onclick="saveSecuritySettings()">
                                    <i class="fas fa-shield-alt me-1"></i>Save Security Settings
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <!-- Account Status Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Account Status</h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <div class="avatar avatar-xl mb-2">
                                    <span class="avatar-initial rounded-circle bg-primary">AD</span>
                                </div>
                                <h5>Administrator</h5>
                                <p class="text-muted">Full System Access</p>
                            </div>
                            
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2 d-flex justify-content-between">
                                    <span>Account Created:</span>
                                    <strong>Jan 15, 2023</strong>
                                </li>
                                <li class="mb-2 d-flex justify-content-between">
                                    <span>Last Login:</span>
                                    <strong>Today, 14:30</strong>
                                </li>
                                <li class="mb-2 d-flex justify-content-between">
                                    <span>Last Password Change:</span>
                                    <strong>Oct 1, 2023</strong>
                                </li>
                                <li class="mb-2 d-flex justify-content-between">
                                    <span>Email Verified:</span>
                                    <span class="badge bg-success">Yes</span>
                                </li>
                                <li class="mb-2 d-flex justify-content-between">
                                    <span>2FA Enabled:</span>
                                    <span class="badge bg-warning">No</span>
                                </li>
                                <li class="d-flex justify-content-between">
                                    <span>Account Status:</span>
                                    <span class="badge bg-success">Active</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Quick Actions Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-bolt me-2"></i>Quick Actions
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="verifyEmail()">
                                    <i class="fas fa-envelope me-1"></i>Verify Email
                                </button>
                                <button class="btn btn-outline-warning" onclick="viewLoginHistory()">
                                    <i class="fas fa-history me-1"></i>View Login History
                                </button>
                                <button class="btn btn-outline-info" onclick="exportAccountData()">
                                    <i class="fas fa-download me-1"></i>Export Account Data
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Danger Zone Card -->
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>Danger Zone
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted">These actions are permanent and cannot be undone.</p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-danger" onclick="deactivateAccount()">
                                    <i class="fas fa-user-slash me-1"></i>Deactivate Account
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteAccount()">
                                    <i class="fas fa-trash me-1"></i>Delete Account
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Delete Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <h6 class="alert-heading">Warning: This action is permanent!</h6>
                    <p class="mb-2">Deleting your account will:</p>
                    <ul class="mb-0">
                        <li>Permanently delete all your data</li>
                        <li>Remove all your permissions and access</li>
                        <li>Delete all your activity logs</li>
                        <li>Cannot be undone</li>
                    </ul>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Enter your password to confirm:</label>
                    <input type="password" class="form-control" id="confirmDeletePassword">
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="understandDelete">
                    <label class="form-check-label" for="understandDelete">
                        I understand that this action cannot be undone
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="proceedDeleteAccount()" disabled id="proceedDeleteBtn">
                    Delete My Account
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Form submission
        document.getElementById('accountInfoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPass = document.getElementById('newPasswordAccount').value;
            const confirmPass = document.getElementById('confirmNewPassword').value;
            
            if (newPass && newPass !== confirmPass) {
                alert('Passwords do not match!');
                return;
            }
            
            if (newPass && newPass.length < 8) {
                alert('Password must be at least 8 characters long!');
                return;
            }
            
            alert('Account information updated successfully!');
        });
        
        // Delete account confirmation
        document.getElementById('understandDelete').addEventListener('change', function() {
            const password = document.getElementById('confirmDeletePassword').value;
            document.getElementById('proceedDeleteBtn').disabled = !(this.checked && password.length > 0);
        });
        
        document.getElementById('confirmDeletePassword').addEventListener('input', function() {
            const checked = document.getElementById('understandDelete').checked;
            document.getElementById('proceedDeleteBtn').disabled = !(checked && this.value.length > 0);
        });
    });

    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
        input.setAttribute('type', type);
    }

    function generatePassword(passwordId, confirmId) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
        let password = '';
        for (let i = 0; i < 12; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById(passwordId).value = password;
        if (confirmId) {
            document.getElementById(confirmId).value = password;
        }
    }

    function resetAccountForm() {
        if (confirm('Reset all changes?')) {
            document.getElementById('accountInfoForm').reset();
        }
    }

    function saveSecuritySettings() {
        alert('Security settings saved!');
    }

    function verifyEmail() {
        alert('Verification email sent!');
    }

    function viewLoginHistory() {
        alert('Redirecting to login history...');
    }

    function exportAccountData() {
        alert('Account data export started. You will receive an email when it\'s ready.');
    }

    function deactivateAccount() {
        if (confirm('Are you sure you want to deactivate your account?')) {
            alert('Account deactivation request sent to administrator.');
        }
    }

    function deleteAccount() {
        $('#deleteAccountModal').modal('show');
    }

    function proceedDeleteAccount() {
        alert('Account deletion scheduled. You will receive a confirmation email.');
        $('#deleteAccountModal').modal('hide');
        // Redirect or logout
        setTimeout(() => {
            window.location.href = "{% url 'accounts:login' %}";
        }, 2000);
    }
</script>
{% endblock %}