{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container-fluid py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-primary text-white py-4">
                    <div class="text-center">
                        <h2 class="fw-bold mb-2">Institution Registration</h2>
                        <p class="mb-0">Complete your institution profile to access all features</p>
                    </div>
                </div>
                
                <div class="card-body p-5">
                    <div class="registration-progress mb-5">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="step active">
                                <div class="step-number">1</div>
                                <div class="step-label">Basic Info</div>
                            </div>
                            <div class="step-line active"></div>
                            <div class="step active">
                                <div class="step-number">2</div>
                                <div class="step-label">Location</div>
                            </div>
                            <div class="step-line"></div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-label">Account</div>
                            </div>
                            <div class="step-line"></div>
                            <div class="step">
                                <div class="step-number">4</div>
                                <div class="step-label">Verification</div>
                            </div>
                        </div>
                    </div>

                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="mb-5">
                            <h4 class="text-primary mb-4">Institution Details</h4>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.name|as_crispy_field }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.institution_type|as_crispy_field }}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.registration_number|as_crispy_field }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.clusters_count|as_crispy_field }}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                {{ form.description|as_crispy_field }}
                            </div>
                        </div>

                        <div class="mb-5">
                            <h4 class="text-primary mb-4">Location Information</h4>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.country|as_crispy_field }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.region|as_crispy_field }}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.constituency|as_crispy_field }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.ward|as_crispy_field }}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                {{ form.street_address|as_crispy_field }}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.phone|as_crispy_field }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.website|as_crispy_field }}
                                </div>
                            </div>
                        </div>

                        <div class="mb-5">
                            <h4 class="text-primary mb-4">Account Setup</h4>
                            
                            <div class="mb-3">
                                {{ form.email|as_crispy_field }}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.password|as_crispy_field }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.confirm_password|as_crispy_field }}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.pin|as_crispy_field }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.confirm_pin|as_crispy_field }}
                                </div>
                            </div>
                        </div>

                        <div class="mb-5">
                            <h4 class="text-primary mb-4">Contact Person</h4>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.contact_name|as_crispy_field }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.contact_position|as_crispy_field }}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.contact_email|as_crispy_field }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.contact_phone|as_crispy_field }}
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="terms" id="terms" required>
                                <label class="form-check-label" for="terms">
                                    I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms and Conditions</a>
                                </label>
                                <div class="invalid-feedback">
                                    You must agree before submitting.
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'accounts:login' %}" class="btn btn-outline-secondary me-md-2">
                                Cancel
                            </a>
                            <button type="submit" class="btn btn-primary px-5">
                                <i class="fas fa-save me-2"></i>Complete Registration
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Terms Modal -->
<div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Institution Agreement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Terms content -->
                <p>Institution registration terms and conditions...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.bg-primary {
    background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%) !important;
}

.btn-primary {
    background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
    border: none;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #244328 0%, #3e6a4a 100%);
}

/* Progress steps */
.registration-progress .step {
    text-align: center;
    position: relative;
}

.registration-progress .step-number {
    width: 40px;
    height: 40px;
    background-color: #e9ecef;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 8px;
    font-weight: bold;
    color: #6c757d;
    border: 2px solid #e9ecef;
}

.registration-progress .step.active .step-number {
    background-color: #2c5530;
    color: white;
    border-color: #2c5530;
}

.registration-progress .step-label {
    font-size: 0.875rem;
    color: #6c757d;
}

.registration-progress .step.active .step-label {
    color: #2c5530;
    font-weight: 600;
}

.registration-progress .step-line {
    flex: 1;
    height: 2px;
    background-color: #e9ecef;
    margin: 0 10px;
    position: relative;
    top: -15px;
}

.registration-progress .step-line.active {
    background-color: #2c5530;
}
</style>

<script>
// Form validation and step navigation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const steps = document.querySelectorAll('.step');
    const stepLines = document.querySelectorAll('.step-line');
    
    // Add validation on blur
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            this.classList.add('touched');
            validateField(this);
        });
    });
    
    // Live validation for required fields
    function validateField(field) {
        if (field.hasAttribute('required')) {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                field.classList.remove('is-valid');
                return false;
            } else {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
                return true;
            }
        }
        return true;
    }
    
    // Update progress based on form completion
    function updateProgress() {
        let completedSteps = 0;
        const sections = form.querySelectorAll('.mb-5');
        
        sections.forEach((section, index) => {
            const inputs = section.querySelectorAll('input, select, textarea[required]');
            let sectionComplete = true;
            
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    sectionComplete = false;
                }
            });
            
            if (sectionComplete && index < steps.length - 1) {
                completedSteps = index + 1;
            }
        });
        
        // Update visual progress
        steps.forEach((step, index) => {
            if (index <= completedSteps) {
                step.classList.add('active');
                if (index > 0) {
                    stepLines[index - 1].classList.add('active');
                }
            } else {
                step.classList.remove('active');
                if (index > 0) {
                    stepLines[index - 1].classList.remove('active');
                }
            }
        });
    }
    
    // Listen for input changes
    inputs.forEach(input => {
        input.addEventListener('input', updateProgress);
    });
    
    // Initial progress update
    updateProgress();
});
</script>
{% endblock %}